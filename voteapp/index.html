<html>
<head>
    <script src="js/jquery-1.9.1.js"></script>
    <script src="js/jquery.mobile-1.3.0.js"></script>
    <script src="js/parse-1.2.2.js"></script>
    <script src="js/config.js"></script>
    <script src="js/underscore.js"></script>
    <script src="js/app.js"></script>
    <link rel="stylesheet" href="css/jquery.mobile-1.3.0.css">
</head>

<script>
	var all_tracks = [];

	window.onload = function() {
		Parse.initialize(config.appid, config.js_key);

		$(".tracks").delegate("li", "tap", function () {
    		var index = $(this).index();
    		var track = all_tracks[index];
    		if (!track) { return };
    		setTrackVote({ 
    			track: track,
    			/** This processing should be done in the backend **/
    			votes: track.attributes.votes + 1,
    			on: function (track) {
    				refreshTracksView(all_tracks);
    			}
    		});
		});	

		loadTracks({
			on: function (tracks) {
				all_tracks = _.clone(all_tracks).concat(tracks);
				refreshTracksView(all_tracks);
			}
		});
	}
	var spotifyUrl = function(href) {
		return "http://ws.spotify.com/lookup/1/.json?uri=" + href;
	}

	var refreshTracksView = function (tracks) {
		var _artistNames = function (artists) {
			return _.map(artists, function (artist) { 
				return artist.name
			}).join(", ");
		}
		$(".tracks").empty();

		$(".tracks").append("<li data-role='list-divider'>Playlist</li>")
				// fix this later
		var gear_link = '<a href="#purchase" data-rel="popup" data-position-to="window" data-transition="pop">Purchase album</a>'
		
		all_tracks = sortByVotes(tracks);

		_.each(all_tracks, function(track) {
			/** Not optimized , so slow **/
			$.getJSON(spotifyUrl(track.attributes.href), function (data) {
				$(".tracks").append("<li><a href='#'>" + data.track.name + "<br/>" +
					"<small>" + _artistNames(data.track.artists) + "</small>" +
					"<span class='ui-li-count'>" + track.attributes.votes + "</span>" + 
					"</a>" + gear_link + "</li>");
				$(".tracks").listview("refresh");
			});
		});
	}

</script>
<body>

<ul class="tracks" data-role="listview" data-split-icon="gear">
</ul>

</body>
